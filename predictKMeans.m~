function [x_hat,dx_hat]=predictKMeans(features,db,weights,x0)
%
%
% K-means prediction bases on feature input, databse db,
% and weights
% 
% features - LxM (each row a sample, column is feature)
%
% db - NxM+2 (each row a sample, column is feature)
%             Firt two colums is the predictor and its rate of change
% weights -Mx1
%
% x0 - LxM previous Lactate value


K=10; %the the closes K neighborhs only
%subtract input feature from db  and get Euclidean distance
[N,M]=size(db);
L=length(features(:,1));
x_hat=zeros(L,1);
dxhat=zeros(L,1);
for i=1:L
    err=(db(:,3:end)-repmat(features.*weights,[N 1])).^2;
    Kdist=sortrows([[1:N]' sqrt(sum(err,2))],2);   
    %Estimate rate of change from K-means
    kind=Kdist(1:K,1);
    kweight=1./Kdist(1:K,2); %Weight neighbohrs by their distance
    kweight=kweight./sum(kweight);
    x_hat(i)=x0 + db(kind,2)'*kweight; 
end